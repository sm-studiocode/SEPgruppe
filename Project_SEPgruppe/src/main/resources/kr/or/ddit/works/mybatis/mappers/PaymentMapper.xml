<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.or.ddit.works.mybatis.mappers.PaymentMapper">

	<!-- “구독하기 버튼” 누르면 실행되는 구독 생성 MAPPER -->
    <insert id="insertPayment" parameterType="PaymentsVO">
        INSERT INTO PAYMENTS (
            PAYMENT_NO,         -- 주문번호 (merchantUid)
            SUBSCRIPTION_NO,    -- 어떤 구독에 속한 결제인지
            CONTACT_ID,         -- 회사 ID
            PAYMENT_DATE,       -- 결제 생성 시각
            PAYMENT_AMOUNT,     -- 금액
            PAYMENT_METHOD,     -- 카드/계좌 등
            PAYMENT_STATUS,     -- 예약됨 / 결제완료 등
            AUTO_PAYMENT        -- 자동결제 여부
        ) VALUES (
            #{paymentNo},
            #{subscriptionNo},
            #{contactId},
            SYSDATE,            -- DB 서버 기준 현재 시각
            #{paymentAmount},
            'CARD',
            '결제완료',
            'Y'
        )
    </insert>

	<!-- 카드 등록 후 발급받은 billingKey(customerUid)를 DB에 저장하는 MAPPER -->
    <insert id="saveBilling" parameterType="BillingKeyVO">

        <selectKey keyProperty="billingKeyId" resultType="long" order="BEFORE">
            SELECT SEQ_BILLING_KEY_ID.NEXTVAL FROM DUAL
        </selectKey>

        INSERT INTO BILLING_KEY (
            BILLING_KEY_ID,
            CONTACT_ID,
            BILLING_KEY,
            CREATE_AT,
            UPDATE_AT
        ) VALUES (
            #{billingKeyId},
            #{contactId},
            #{billingKey},
            SYSDATE,
            SYSDATE
        )
    </insert>

	<!-- 회사가 카드 등록했는지 확인하는 MAPPER -->
    <select id="selectBilling" parameterType="string" resultType="BillingKeyVO">
        SELECT *
        FROM (
            SELECT
                BILLING_KEY_ID,
                CONTACT_ID,
                BILLING_KEY,
                CREATE_AT,
                UPDATE_AT
            FROM BILLING_KEY
            WHERE CONTACT_ID = #{contactId}
            ORDER BY CREATE_AT DESC, BILLING_KEY_ID DESC
        )
        WHERE ROWNUM = 1
    </select>

	<!-- 결제내역 목록 조회 MAPPER -->
    <select id="paymentList" resultType="PaymentsVO">
        SELECT
            PAYMENT_NO,
            SUBSCRIPTION_NO,
            CONTACT_ID,
            TO_CHAR(PAYMENT_DATE,'YYYY-MM-DD') AS PAYMENT_DATE,
            PAYMENT_AMOUNT,
            PAYMENT_METHOD,
            PAYMENT_STATUS,
            AUTO_PAYMENT
        FROM PAYMENTS
        ORDER BY PAYMENT_DATE DESC
    </select>

	<!-- 고객사 관리의 고객사 결제 이력 조회 -->
	<select id="paymentListByContactId" parameterType="string" resultType="PaymentsVO">
	  SELECT
	      PAYMENT_NO,
	      SUBSCRIPTION_NO,
	      CONTACT_ID,
	      TO_CHAR(PAYMENT_DATE,'YYYY-MM-DD') AS PAYMENT_DATE,
	      PAYMENT_AMOUNT,
	      PAYMENT_METHOD,
	      PAYMENT_STATUS,
	      AUTO_PAYMENT
	  FROM 
	  	PAYMENTS
	  WHERE 
	  	CONTACT_ID = #{contactId}
	  ORDER BY 
	  	PAYMENT_DATE DESC
	</select>
</mapper>
