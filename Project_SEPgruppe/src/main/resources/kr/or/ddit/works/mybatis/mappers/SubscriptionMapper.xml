<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.or.ddit.works.mybatis.mappers.SubscriptionMapper">

	<!-- 구독 플랜 전체 조회 -->
    <select id="planList" resultType="SubscriptionPlansVO">
        SELECT
            PLAN_TYPE,
            MONTHLY_PRICE,
            ANNUAL_PRICE,
            MAINTAIN_OLD_PRICE,
            PLAN_NO,
            MAXIMUM_PEOPLE
        FROM SUBSCRIPTION_PLANS
    </select>

	<!-- 구독 플랜 단건 조회 -->
    <select id="planOne" resultType="SubscriptionPlansVO">
        SELECT
            PLAN_TYPE,
            MONTHLY_PRICE,
            ANNUAL_PRICE,
            MAINTAIN_OLD_PRICE,
            PLAN_NO,
            MAXIMUM_PEOPLE
        FROM SUBSCRIPTION_PLANS
        WHERE PLAN_TYPE = #{planType}
    </select>


    <!-- 구독 정보 INSERT -->
    <insert id="insertSubscription" parameterType="SubscriptionsVO">

        <selectKey keyProperty="subscriptionNo" resultType="long" order="BEFORE">
            SELECT SEQ_SUBSCRIPTION_NO.NEXTVAL FROM DUAL
        </selectKey>

        INSERT INTO SUBSCRIPTIONS (
            SUBSCRIPTION_NO,
            CONTACT_ID,
            PAYMENT_STATUS,
            SUBSCRIPTION_START,
            SUBSCRIPTION_END,
            SUBSCRIPTIONS_ACTIVE,
            PLAN_TYPE,
            BILLING_DATE,
            BILLING_KEY_ID,
            AUTO_PAYMENT
        ) VALUES (
            #{subscriptionNo},
            #{contactId},
            '결제 완료',
            #{subscriptionStart},
            #{subscriptionEnd},
            'Y',
            #{planType},
            #{billingDate},
            #{billingKeyId},
            'Y'
        )
    </insert>

	<resultMap type="SubscriptionsVO" id="subMap" autoMapping="true">
	    <association property="subscriptionPlan"
	                 javaType="SubscriptionPlansVO"
	                 autoMapping="true">
	        <result property="monthlyPrice" column="MONTHLY_PRICE"/>
	    </association>
	</resultMap>

	<!-- 마이페이지에서 사용자의 구독정보 조회 -->
	<select id="selectSubscription" resultMap="subMap">
	    SELECT
	        s.SUBSCRIPTION_NO,
	        s.CONTACT_ID,
	        s.PAYMENT_STATUS,
	        TO_CHAR(s.SUBSCRIPTION_START, 'YYYY-MM-DD') AS SUBSCRIPTION_START,
	        TO_CHAR(s.SUBSCRIPTION_END, 'YYYY-MM-DD') AS SUBSCRIPTION_END,
	        s.SUBSCRIPTIONS_ACTIVE,
	        s.PLAN_TYPE,
	        s.BILLING_DATE,
	        s.BILLING_KEY_ID,
	        s.AUTO_PAYMENT,
	        p.MONTHLY_PRICE
	    FROM SUBSCRIPTIONS s
	    JOIN SUBSCRIPTION_PLANS p
	      ON s.PLAN_TYPE = p.PLAN_TYPE
	    WHERE s.CONTACT_ID = #{contactId}
	      AND s.SUBSCRIPTIONS_ACTIVE = 'Y'
	</select>
	
	<!-- 관리자 페이지에서 모든 회사의 현재 구독 현황 조회 -->
	<select id="subscriptionList" resultMap="subMap">
		SELECT
		    SUBSCRIPTION_NO,
		    CONTACT_ID,
		    PAYMENT_STATUS,
		    SUBSCRIPTION_START,
		    SUBSCRIPTION_END,
		    SUBSCRIPTIONS_ACTIVE,
		    PLAN_TYPE,
		    BILLING_DATE,
		    BILLING_KEY_ID,
		    AUTO_PAYMENT,
		    MONTHLY_PRICE
		FROM (
		    SELECT
		        s.SUBSCRIPTION_NO,
		        s.CONTACT_ID,
		        s.PAYMENT_STATUS,
		        TO_CHAR(s.SUBSCRIPTION_START, 'YYYY-MM-DD') AS SUBSCRIPTION_START,
		        TO_CHAR(s.SUBSCRIPTION_END,   'YYYY-MM-DD') AS SUBSCRIPTION_END,
		        s.SUBSCRIPTIONS_ACTIVE,
		        s.PLAN_TYPE,
		        s.BILLING_DATE,
		        s.BILLING_KEY_ID,
		        s.AUTO_PAYMENT,
		        p.MONTHLY_PRICE,
		        ROW_NUMBER() OVER(
		            PARTITION BY s.CONTACT_ID
		            ORDER BY s.SUBSCRIPTION_NO DESC
		        ) rn
		    FROM SUBSCRIPTIONS s
		    JOIN SUBSCRIPTION_PLANS p
		      ON s.PLAN_TYPE = p.PLAN_TYPE
		)
		WHERE rn = 1
		ORDER BY SUBSCRIPTION_NO DESC
	</select>
	
	<!-- 관리자 페이지 구독 플랜 정보 수정 -->
	<update id="updatePlan" parameterType="SubscriptionPlansVO">
		UPDATE 
			SUBSCRIPTION_PLANS
		SET 
			MONTHLY_PRICE = #{monthlyPrice},
		 	ANNUAL_PRICE = #{annualPrice},
			MAINTAIN_OLD_PRICE = #{maintainOldPrice},
			MAXIMUM_PEOPLE = #{maximumPeople}
		WHERE 
			PLAN_NO = #{planNo}
	</update>
	
	<!-- contactId 기준으로 활성화된 구독을 가지고 있는지 확인 -->
	<select id="selectActiveSubscriptionByContactId" resultType="SubscriptionsVO">
	    SELECT
			*
	    FROM 
	    	SUBSCRIPTIONS
	    WHERE 
	    	CONTACT_ID = #{contactId}
		AND 
			SUBSCRIPTIONS_ACTIVE = 'Y'
  		FETCH FIRST 1 ROWS ONLY
	</select>
	
	<!-- 구독 해지 -->
	<update id="cancelActiveSubscriptionByContactId" parameterType="string">
	  UPDATE SUBSCRIPTIONS
	  SET
	      SUBSCRIPTIONS_ACTIVE = 'N',
	      AUTO_PAYMENT = 'N',
	      PAYMENT_STATUS = '해지',
	      SUBSCRIPTION_END = SYSDATE
	  WHERE 
	  	CONTACT_ID = #{contactId}
	  AND 
	    SUBSCRIPTIONS_ACTIVE = 'Y'
	</update>
	
</mapper>
